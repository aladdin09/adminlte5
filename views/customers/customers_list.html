{{extend 'layout_gentelella_bs5.html'}}

{{block header}}
{{if breadcrumbs:}}
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb mb-0">
    {{for crumb in breadcrumbs:}}
    {{if crumb['url']:}}
    <li class="breadcrumb-item"><a href="{{=crumb['url']}}">{{=crumb['label']}}</a></li>
    {{else:}}
    <li class="breadcrumb-item active" aria-current="page">{{=crumb['label']}}</li>
    {{pass}}
    {{pass}}
  </ol>
</nav>
{{pass}}
{{end}}

<div class="container-fluid mt-2">
  <!-- Поиск -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body py-3">
          <form method="get" action="{{=URL('customers', 'customers_list')}}" class="d-flex flex-wrap gap-2 align-items-center">
            <div class="flex-grow-1" style="min-width: 200px;">
              <input type="text" name="search" class="form-control" placeholder="Поиск по имени, телефону, email или адресу..." value="{{=search_term or ''}}">
            </div>
            <button type="submit" class="btn btn-primary"><i class="bi bi-search me-1"></i> Найти</button>
            {{if search_term:}}
            <a href="{{=URL('customers', 'customers_list')}}" class="btn btn-outline-secondary"><i class="bi bi-x-lg me-1"></i> Сбросить</a>
            {{pass}}
            <button type="button" class="btn btn-success ms-auto" onclick="openSidebar()">
              <i class="bi bi-person-plus me-1"></i> Добавить клиента
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Таблица клиентов -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i> Клиенты ({{=len(customers) if customers else 0}})</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
              <thead class="thead-light">
                <tr>
                  <th>ID</th>
                  <th>Имя</th>
                  <th>Телефон</th>
                  <th>Email</th>
                  <th>Адрес</th>
                  <th>Дата создания</th>
                  <th>Дата изменения</th>
                </tr>
              </thead>
              <tbody>
                {{if customers:}}
                {{for customer in customers:}}
                <tr class="customer-row" onclick="window.location.href='{{=URL('customers', 'customer', args=[customer.id])}}'" style="cursor: pointer;">
                  <td>#{{=customer.id}}</td>
                  <td><strong>{{=customer.name}}</strong></td>
                  <td>
                    {{if customer.phone:}}
                    <a href="tel:{{=customer.phone}}" onclick="event.stopPropagation();">{{=customer.phone}}</a>
                    {{else:}}
                    <span class="text-muted">-</span>
                    {{pass}}
                  </td>
                  <td>
                    {{if customer.email:}}
                    <a href="mailto:{{=customer.email}}" onclick="event.stopPropagation();">{{=customer.email}}</a>
                    {{else:}}
                    <span class="text-muted">-</span>
                    {{pass}}
                  </td>
                  <td>
                    {{if customer.address:}}
                    {{=customer.address[:50] + '...' if len(customer.address) > 50 else customer.address}}
                    {{else:}}
                    <span class="text-muted">-</span>
                    {{pass}}
                  </td>
                  <td>{{=customer.created_on.strftime('%d.%m.%Y %H:%M') if customer.created_on else '-'}}</td>
                  <td>{{=customer.modified_on.strftime('%d.%m.%Y %H:%M') if customer.modified_on else '-'}}</td>
                </tr>
                {{pass}}
                {{else:}}
                <tr>
                  <td colspan="7" class="text-center text-muted py-5">
                    <i class="bi bi-info-circle fs-1 mb-3"></i>
                    <p class="mb-0">Клиенты не найдены</p>
                  </td>
                </tr>
                {{pass}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.customer-row {
  transition: background-color 0.2s ease;
}

.customer-row:hover {
  background-color: #e3f2fd !important;
  transform: scale(1.01);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.customer-row:active {
  background-color: #bbdefb !important;
}

.table tbody tr {
  transition: all 0.2s ease;
}
</style>

<!-- Панель добавления клиента справа -->
<div class="customer-sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="customer-sidebar" id="customerSidebar">
  <div class="customer-sidebar-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white"><i class="bi bi-person-plus me-2"></i> Добавление клиента</h5>
    <button type="button" class="btn btn-light btn-sm" onclick="closeSidebar()"><i class="bi bi-x-lg"></i></button>
  </div>
  <div class="customer-sidebar-body">
    {{=form_customer.custom.begin}}
    {{if form_customer.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_customer.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="mb-3"><label for="customers_name" class="form-label">Имя клиента <span class="text-danger">*</span></label>{{=form_customer.custom.widget.name}}</div>
    <div class="mb-3"><label for="customers_phone" class="form-label">Телефон</label>{{=form_customer.custom.widget.phone}}</div>
    <div class="mb-3"><label for="customers_email" class="form-label">Email</label>{{=form_customer.custom.widget.email}}</div>
    <div class="mb-3"><label for="customers_address" class="form-label">Адрес</label>{{=form_customer.custom.widget.address}}</div>
    <div class="mb-3"><label for="customers_notes" class="form-label">Примечания</label>{{=form_customer.custom.widget.notes}}</div>
    <div class="mb-3">{{=form_customer.custom.submit}}<button type="button" class="btn btn-secondary w-100 mt-2" onclick="closeSidebar()">Отмена</button></div>
    {{=form_customer.custom.end}}
  </div>
</div>

<style>
.customer-sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1040; display: none; }
.customer-sidebar-overlay.show { display: block; }
.customer-sidebar { position: fixed; top: 0; right: -420px; width: 420px; max-width: 100vw; height: 100vh; background: var(--bs-body-bg); box-shadow: -2px 0 12px rgba(0,0,0,.15); transition: right 0.3s ease; z-index: 1050; overflow-y: auto; display: flex; flex-direction: column; }
.customer-sidebar.open { right: 0; }
.customer-sidebar .customer-sidebar-header { padding: 1rem; border-bottom: 1px solid var(--bs-border-color); background: var(--bs-primary); color: #fff; }
.customer-sidebar .customer-sidebar-body { padding: 1rem; flex: 1; overflow-y: auto; }
</style>

<script>
function openSidebar() { document.getElementById('customerSidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
function closeSidebar() { document.getElementById('customerSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); document.body.style.overflow = ''; }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSidebar(); });
</script>
