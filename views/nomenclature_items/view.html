{{extend 'layout_gentelella_bs5.html'}}

{{block header}}
{{if breadcrumbs:}}
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb mb-0">
    {{for crumb in breadcrumbs:}}
    {{if crumb['url']:}}
    <li class="breadcrumb-item"><a href="{{=crumb['url']}}">{{=crumb['label']}}</a></li>
    {{else:}}
    <li class="breadcrumb-item active" aria-current="page">{{=crumb['label']}}</li>
    {{pass}}
    {{pass}}
  </ol>
</nav>
{{pass}}
{{end}}

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Информация о позиции номенклатуры -->
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о позиции номенклатуры</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tr>
              <th width="40%">ID:</th>
              <td>#{{=item.id}}</td>
            </tr>
            <tr>
              <th>Номер:</th>
              <td><strong>{{=item.item_number}}</strong></td>
            </tr>
            <tr>
              <th>Дата:</th>
              <td>{{=item.item_date.strftime('%d.%m.%Y') if item.item_date else '-'}}</td>
            </tr>
            <tr>
              <th>Единица измерения:</th>
              <td>{{=getattr(item, 'unit', None) or 'шт'}}</td>
            </tr>
            <tr>
              <th>Общая стоимость:</th>
              <td><strong class="text-success" style="font-size: 1.2em;">{{=f"{float(item.total_cost or 0):,.2f}".replace(',', ' ')}} ₽</strong></td>
            </tr>
            {{if item.description:}}
            <tr>
              <th>Описание:</th>
              <td>{{=item.description}}</td>
            </tr>
            {{pass}}
            <tr>
              <th>Дата создания:</th>
              <td>{{=item.created_on.strftime('%d.%m.%Y %H:%M') if item.created_on else '-'}}</td>
            </tr>
            <tr>
              <th>Дата изменения:</th>
              <td>{{=item.modified_on.strftime('%d.%m.%Y %H:%M') if item.modified_on else '-'}}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Действия -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-cog"></i> Действия</h5>
        </div>
        <div class="card-body">
          <div class="btn-group-vertical w-100" role="group">
            <button type="button" class="btn btn-primary mb-2" onclick="openNomenclatureViewEditPanel()">
              <i class="bi bi-pencil"></i> Редактировать позицию
            </button>
            <a href="{{=URL('nomenclature_items', 'delete', args=[item.id])}}" 
               class="btn btn-danger mb-2"
               onclick="return confirm('Вы уверены, что хотите удалить эту позицию номенклатуры?');">
              <i class="bi bi-trash"></i> Удалить позицию
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{if form_edit:}}
<style>
.nomenclature-view-edit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1040; display: none; }
.nomenclature-view-edit-overlay.show { display: block; }
.nomenclature-view-edit-sidebar { position: fixed; top: 0; right: -420px; width: 420px; max-width: 100vw; height: 100vh; background: var(--bs-body-bg); box-shadow: -2px 0 12px rgba(0,0,0,.15); transition: right 0.3s ease; z-index: 1050; overflow-y: auto; display: flex; flex-direction: column; }
.nomenclature-view-edit-sidebar.open { right: 0; }
.nomenclature-view-edit-sidebar .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--bs-border-color); background: var(--bs-primary); color: #fff; }
.nomenclature-view-edit-sidebar .sidebar-body { padding: 1rem; flex: 1; overflow-y: auto; }
</style>
<div class="nomenclature-view-edit-overlay" id="nomenclatureViewEditOverlay" onclick="closeNomenclatureViewEditPanel()"></div>
<div class="nomenclature-view-edit-sidebar" id="nomenclatureViewEditSidebar">
  <div class="sidebar-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white"><i class="bi bi-pencil me-2"></i> Редактирование позиции</h5>
    <button type="button" class="btn btn-light btn-sm" onclick="closeNomenclatureViewEditPanel()"><i class="bi bi-x-lg"></i></button>
  </div>
  <div class="sidebar-body">
    {{=form_edit.custom.begin}}
    {{if form_edit.errors:}}
    <div class="alert alert-danger">
      <strong>Ошибки:</strong>
      <ul class="mb-0">{{for field, error in form_edit.errors.items():}}<li>{{=field}}: {{=error}}</li>{{pass}}</ul>
    </div>
    {{pass}}
    <div class="mb-3"><label class="form-label">Номер <span class="text-danger">*</span></label>{{=form_edit.custom.widget.item_number}}</div>
    <div class="mb-3"><label class="form-label">Дата</label>{{=form_edit.custom.widget.item_date}}</div>
    <div class="mb-3"><label class="form-label">Ед. изм.</label>{{=form_edit.custom.widget.unit}}</div>
    <div class="mb-3"><label class="form-label">Стоимость</label>{{=form_edit.custom.widget.total_cost}}</div>
    <div class="mb-3"><label class="form-label">Описание</label>{{=form_edit.custom.widget.description}}</div>
    <div class="mb-3">{{=form_edit.custom.submit}}<button type="button" class="btn btn-secondary w-100 mt-2" onclick="closeNomenclatureViewEditPanel()">Отмена</button></div>
    {{=form_edit.custom.end}}
  </div>
</div>
<script>
function openNomenclatureViewEditPanel() { var ov = document.getElementById('nomenclatureViewEditOverlay'); var panel = document.getElementById('nomenclatureViewEditSidebar'); if (ov) ov.classList.add('show'); if (panel) panel.classList.add('open'); document.body.style.overflow = 'hidden'; }
function closeNomenclatureViewEditPanel() { var ov = document.getElementById('nomenclatureViewEditOverlay'); var panel = document.getElementById('nomenclatureViewEditSidebar'); if (ov) ov.classList.remove('show'); if (panel) panel.classList.remove('open'); document.body.style.overflow = ''; }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeNomenclatureViewEditPanel(); });
</script>
{{pass}}
